/**
 * @fileoverview added by tsickle
 * Generated from: lib/chip-autocomplete.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, forwardRef, Input, ViewChild, ElementRef, ChangeDetectionStrategy, Output, EventEmitter } from '@angular/core';
import { NG_VALUE_ACCESSOR, FormBuilder } from '@angular/forms';
import { MatAutocomplete } from '@angular/material/autocomplete';
import { Observable, Subject, timer } from 'rxjs';
import { distinctUntilChanged, debounce } from 'rxjs/operators';
var ChipAutocompleteComponent = /** @class */ (function () {
    function ChipAutocompleteComponent(fb) {
        var _this = this;
        this.fb = fb;
        this.placeholder = 'Select';
        this.clientSideFilter = true;
        this.maxItems = null;
        this.removable = true;
        this.required = true;
        this.isOptionString = true;
        this.displayWith = 'value';
        this.itemId = 'key';
        this.disabledSelected = true;
        this.debounceTime = 500;
        this.isChipAddFromInput = false;
        this.isOptionCheckable = false;
        this.changeSearchkey = new EventEmitter();
        this.separatorKeysCodes = [13, 9];
        this.onTouch = (/**
         * @return {?}
         */
        function () { });
        this.onChange = (/**
         * @return {?}
         */
        function () { });
        this.disabled = false;
        this.debounceHelper = new Subject();
        this.isSelected = (/**
         * @param {?} option
         * @return {?}
         */
        function (option) {
            return _this.control.value && _this.control.value.some((/**
             * @param {?} ctr
             * @return {?}
             */
            function (ctr) {
                return _this.isOptionString ? ctr === option : ctr[_this.itemId] === option[_this.itemId];
            }));
        });
    }
    /**
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.changeInput('');
        this.form = this.fb.group({
            control: [''],
        });
        this.form.valueChanges.subscribe((/**
         * @param {?} form
         * @return {?}
         */
        function (form) {
            setTimeout((/**
             * @return {?}
             */
            function () { return _this.onChange(form.control); }), 0);
        }));
        this.debounceHelper.pipe(debounce((/**
         * @return {?}
         */
        function () { return timer(_this.debounceTime); })), distinctUntilChanged()).subscribe((/**
         * @param {?} res
         * @return {?}
         */
        function (res) { return _this.changeSearchkey.emit(res); }));
        if (this.clientSideFilter) {
            if (this.options.some((/**
             * @param {?} option
             * @return {?}
             */
            function (option) { return typeof (option) === 'string'; }))) {
                this.isOptionString = true;
            }
            else {
                this.isOptionString = false;
            }
        }
    };
    Object.defineProperty(ChipAutocompleteComponent.prototype, "control", {
        get: /**
         * @return {?}
         */
        function () {
            return this.form.get('control');
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} event
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.add = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        if (this.isChipAddFromInput && !this.matAutocomplete.showPanel) {
            /** @type {?} */
            var input = event.input;
            /** @type {?} */
            var value = event.value;
            if (this.isOptionString) {
                if ((value || '').trim()) {
                    this.control.setValue(tslib_1.__spread(this.control.value || [], [value.trim()]));
                }
            }
            else {
                /** @type {?} */
                var obj = {};
                obj[this.itemId] = value;
                obj[this.displayWith] = value;
                this.control.setValue(tslib_1.__spread(this.control.value || [], [obj]));
            }
            // Reset the input value
            if (input) {
                input.value = '';
            }
        }
    };
    /**
     * @param {?} chip
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.remove = /**
     * @param {?} chip
     * @return {?}
     */
    function (chip) {
        var _this = this;
        /** @type {?} */
        var index = this.control.value.findIndex((/**
         * @param {?} ctr
         * @return {?}
         */
        function (ctr) {
            return _this.isOptionString ? ctr === chip : ctr[_this.itemId] === chip[_this.itemId];
        }));
        if (index >= 0) {
            this.changeInput();
            this.control.value.splice(index, 1);
            if (this.control.value.length === 0) {
                this.control.setValue(null);
            }
            else {
                this.control.updateValueAndValidity();
            }
            this.disabled = false;
        }
    };
    /**
     * @param {?=} key
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.changeInput = /**
     * @param {?=} key
     * @return {?}
     */
    function (key) {
        if (key === void 0) { key = ''; }
        this.clientSideFilter ? this.filteredOptions = this.filterOption(key) : this.debounceHelper.next(key);
    };
    /**
     * @param {?} key
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.filterOption = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        return (key === '') ? this.options : this.options.filter((/**
         * @param {?} f
         * @return {?}
         */
        function (f) {
            return _this.isOptionString ? f.toLowerCase().includes(key.toLowerCase()) :
                (f[_this.displayWith]).toLowerCase().includes(key.toLowerCase());
        }));
    };
    /**
     * @param {?} value
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.onSelect = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        this.control.setValue(tslib_1.__spread(this.control.value || [], [value]));
        this.afterSelect();
    };
    /**
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.afterSelect = /**
     * @return {?}
     */
    function () {
        this.input.nativeElement.value = '';
        if (this.maxItems && this.control.value.length === this.maxItems) {
            this.disabled = true;
        }
        this.changeInput();
    };
    /**
     * @param {?} keyCode
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.chooseFirstOption = /**
     * @param {?} keyCode
     * @return {?}
     */
    function (keyCode) {
        var _this = this;
        if (this.matAutocomplete.options.first && (!this.control.value || (this.control.value && !this.control.value.some((/**
         * @param {?} ctr
         * @return {?}
         */
        function (ctr) {
            return _this.isOptionString ? ctr === _this.matAutocomplete.options.first.value :
                ctr[_this.itemId] === _this.matAutocomplete.options.first.value[_this.itemId];
        }))))) {
            if (keyCode === 'enter') {
                this.matAutocomplete.options.first.select();
            }
            else if (keyCode === 'tab') {
                this.control.setValue(tslib_1.__spread(this.control.value || [], [this.matAutocomplete.options.first.value]));
                this.afterSelect();
            }
        }
    };
    /**
     * @param {?} $event
     * @param {?} option
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.clickCheckboxWrap = /**
     * @param {?} $event
     * @param {?} option
     * @return {?}
     */
    function ($event, option) {
        $event.stopPropagation();
        this.toggleSelection(option);
    };
    /**
     * @param {?} option
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.toggleSelection = /**
     * @param {?} option
     * @return {?}
     */
    function (option) {
        if (this.isSelected(option)) {
            this.remove(option);
        }
        else {
            if (!this.control.value || !this.maxItems || this.control.value.length < this.maxItems) {
                this.onSelect(option);
            }
        }
    };
    /**
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.onBlur = /**
     * @return {?}
     */
    function () {
        this.input.nativeElement.value = '';
        this.changeInput();
    };
    /**
     * @param {?} fn
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.registerOnTouched = /**
     * @param {?} fn
     * @return {?}
     */
    function (fn) {
        this.onTouch = fn;
    };
    /**
     * @param {?} fn
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.registerOnChange = /**
     * @param {?} fn
     * @return {?}
     */
    function (fn) {
        this.onChange = fn;
    };
    /**
     * @param {?} val
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.writeValue = /**
     * @param {?} val
     * @return {?}
     */
    function (val) {
        this.control.setValue(val);
    };
    /**
     * @param {?} isDisabled
     * @return {?}
     */
    ChipAutocompleteComponent.prototype.setDisabledState = /**
     * @param {?} isDisabled
     * @return {?}
     */
    function (isDisabled) {
        this.disabled = isDisabled;
    };
    ChipAutocompleteComponent.decorators = [
        { type: Component, args: [{
                    selector: 'chip-autocomplete',
                    template: "<form [formGroup]=\"form\" class=\"form\">\n    <mat-form-field class=\"form-element\">\n        <mat-chip-list #chipList formControlName=\"control\" [required]=\"required\">\n            <mat-chip *ngFor=\"let ctr of control.value\" [removable]=\"true\" (removed)=\"remove(ctr)\">\n                {{ isOptionString ? ctr : ctr[displayWith] }}\n                <mat-icon matChipRemove *ngIf=\"removable\">cancel</mat-icon>\n            </mat-chip>\n            <input #input matInput [placeholder]=\"placeholder\" (input)=\"changeInput($event.target.value)\"\n                [matChipInputFor]=\"chipList\" [matAutocomplete]=\"ref\" (matChipInputTokenEnd)=\"add($event)\"\n                [disabled]=\"disabled\" (keyup.enter)=\"chooseFirstOption('enter')\" (keyup.tab)=\"chooseFirstOption('tab')\"\n                (blur)=\"onBlur()\" (focus)=\"changeInput()\" [matChipInputSeparatorKeyCodes]=\"separatorKeysCodes\">\n            <mat-autocomplete #ref=\"matAutocomplete\" (optionSelected)=\"onSelect($event.option.value)\">\n                <ng-container *ngIf=\"!isOptionCheckable\">\n                    <mat-option *ngFor=\"let ctr of (clientSideFilter? filteredOptions : (filteredOptions$ | async))\"\n                        [value]=\"ctr\" [disabled]=\"disabledSelected && isSelected(ctr)\">\n                        {{ isOptionString ? ctr : ctr[displayWith] }}\n                    </mat-option>\n                </ng-container>\n                <ng-container *ngIf=\"isOptionCheckable\">\n                    <mat-option class=\"option-checkbox-wrap\" *ngFor=\"let ctr of (clientSideFilter? filteredOptions : (filteredOptions$ | async))\"\n                        [value]=\"ctr\">\n                        <div (click)=\"clickCheckboxWrap($event, ctr)\">\n                            <mat-checkbox [checked]=\"isSelected(ctr)\"\n                                [disabled]=\"!isSelected(ctr) && control.value && maxItems && control.value.length >= maxItems\"\n                                (change)=\"toggleSelection(ctr)\" (click)=\"$event.stopPropagation()\">\n                                {{ isOptionString ? ctr : ctr[displayWith] }}\n                            </mat-checkbox>\n                        </div>\n                    </mat-option>\n                </ng-container>\n            </mat-autocomplete>\n        </mat-chip-list>\n    </mat-form-field>\n</form>",
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    providers: [
                        {
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef((/**
                             * @return {?}
                             */
                            function () { return ChipAutocompleteComponent; })),
                            multi: true
                        }
                    ],
                    styles: [".form{min-width:150px;max-width:500px;width:100%}.form-element{padding:5px 0 25px 40px;width:100%}.mat-option.option-checkbox-wrap{padding:0}.mat-option.option-checkbox-wrap .mat-checkbox{padding:0 16px}.mat-option:first-child{background:rgba(0,0,0,.04)}"]
                }] }
    ];
    /** @nocollapse */
    ChipAutocompleteComponent.ctorParameters = function () { return [
        { type: FormBuilder }
    ]; };
    ChipAutocompleteComponent.propDecorators = {
        placeholder: [{ type: Input }],
        clientSideFilter: [{ type: Input }],
        options: [{ type: Input }],
        maxItems: [{ type: Input }],
        removable: [{ type: Input }],
        required: [{ type: Input }],
        isOptionString: [{ type: Input }],
        displayWith: [{ type: Input }],
        itemId: [{ type: Input }],
        disabledSelected: [{ type: Input }],
        filteredOptions$: [{ type: Input }],
        debounceTime: [{ type: Input }],
        isChipAddFromInput: [{ type: Input }],
        isOptionCheckable: [{ type: Input }],
        changeSearchkey: [{ type: Output }],
        input: [{ type: ViewChild, args: ['input', { static: false },] }],
        matAutocomplete: [{ type: ViewChild, args: [MatAutocomplete, { static: true },] }]
    };
    return ChipAutocompleteComponent;
}());
export { ChipAutocompleteComponent };
if (false) {
    /** @type {?} */
    ChipAutocompleteComponent.prototype.placeholder;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.clientSideFilter;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.options;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.maxItems;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.removable;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.required;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.isOptionString;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.displayWith;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.itemId;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.disabledSelected;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.filteredOptions$;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.debounceTime;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.isChipAddFromInput;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.isOptionCheckable;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.changeSearchkey;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.input;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.matAutocomplete;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.separatorKeysCodes;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.onTouch;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.onChange;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.form;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.filteredOptions;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.disabled;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.debounceHelper;
    /** @type {?} */
    ChipAutocompleteComponent.prototype.isSelected;
    /**
     * @type {?}
     * @private
     */
    ChipAutocompleteComponent.prototype.fb;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpcC1hdXRvY29tcGxldGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vY2hpcC1hdXRvY29tcGxldGUvIiwic291cmNlcyI6WyJsaWIvY2hpcC1hdXRvY29tcGxldGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsVUFBVSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLHVCQUF1QixFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0ksT0FBTyxFQUFFLGlCQUFpQixFQUF3QixXQUFXLEVBQWEsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDakUsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRTtJQXdDRSxtQ0FBb0IsRUFBZTtRQUFuQyxpQkFBd0M7UUFBcEIsT0FBRSxHQUFGLEVBQUUsQ0FBYTtRQTFCMUIsZ0JBQVcsR0FBRyxRQUFRLENBQUM7UUFDdkIscUJBQWdCLEdBQUcsSUFBSSxDQUFDO1FBRXhCLGFBQVEsR0FBRyxJQUFJLENBQUM7UUFDaEIsY0FBUyxHQUFHLElBQUksQ0FBQztRQUNqQixhQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLGdCQUFXLEdBQUcsT0FBTyxDQUFDO1FBQ3RCLFdBQU0sR0FBRyxLQUFLLENBQUM7UUFDZixxQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFFeEIsaUJBQVksR0FBRyxHQUFHLENBQUM7UUFDbkIsdUJBQWtCLEdBQUcsS0FBSyxDQUFDO1FBQzNCLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUN6QixvQkFBZSxHQUFH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QUNuQyxvREFBdUQ7O0lBQ3ZELDBDQUEyRTs7SUFDM0Usb0RBQStFOztJQUUvRSx1REFBc0M7O0lBQ3RDLDRDQUF5Qjs7SUFDekIsNkNBQTBCOztJQUMxQix5Q0FBZ0I7O0lBQ2hCLG9EQUFxQjs7SUFDckIsNkNBQWlCOztJQUNqQixtREFBK0I7O0lBdUYvQiwrQ0FHQzs7Ozs7SUF4RlcsdUNBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIGZvcndhcmRSZWYsIElucHV0LCBWaWV3Q2hpbGQsIEVsZW1lbnRSZWYsIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTkdfVkFMVUVfQUNDRVNTT1IsIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBGb3JtQnVpbGRlciwgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgTWF0Q2hpcElucHV0RXZlbnQgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9jaGlwcyc7XG5pbXBvcnQgeyBNYXRBdXRvY29tcGxldGUgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9hdXRvY29tcGxldGUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgdGltZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBkZWJvdW5jZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY2hpcC1hdXRvY29tcGxldGUnLFxuICB0ZW1wbGF0ZVVybDogJy4vY2hpcC1hdXRvY29tcGxldGUuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9jaGlwLWF1dG9jb21wbGV0ZS5jb21wb25lbnQuY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IENoaXBBdXRvY29tcGxldGVDb21wb25lbnQpLFxuICAgICAgbXVsdGk6IHRydWVcbiAgICB9XG4gIF1cbn0pXG5leHBvcnQgY2xhc3MgQ2hpcEF1dG9jb21wbGV0ZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQ29udHJvbFZhbHVlQWNjZXNzb3Ige1xuICBASW5wdXQoKSBwbGFjZWhvbGRlciA9ICdTZWxlY3QnO1xuICBASW5wdXQoKSBjbGllbnRTaWRlRmlsdGVyID0gdHJ1ZTtcbiAgQElucHV0KCkgb3B0aW9uczogYW55W107XG4gIEBJbnB1dCgpIG1heEl0ZW1zID0gbnVsbDtcbiAgQElucHV0KCkgcmVtb3ZhYmxlID0gdHJ1ZTtcbiAgQElucHV0KCkgcmVxdWlyZWQgPSB0cnVlO1xuICBASW5wdXQoKSBpc09wdGlvblN0cmluZyA9IHRydWU7XG4gIEBJbnB1dCgpIGRpc3BsYXlXaXRoID0gJ3ZhbHVlJztcbiAgQElucHV0KCkgaXRlbUlkID0gJ2tleSc7XG4gIEBJbnB1dCgpIGRpc2FibGVkU2VsZWN0ZWQgPSB0cnVlO1xuICBASW5wdXQoKSBmaWx0ZXJlZE9wdGlvbnMkOiBPYnNlcnZhYmxlPGFueT47XG4gIEBJbnB1dCgpIGRlYm91bmNlVGltZSA9IDUwMDtcbiAgQElucHV0KCkgaXNDaGlwQWRkRnJvbUlucHV0ID0gZmFsc2U7XG4gIEBJbnB1dCgpIGlzT3B0aW9uQ2hlY2thYmxlID0gZmFsc2U7XG4gIEBPdXRwdXQoKSBjaGFuZ2VTZWFyY2hrZXkgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgQFZpZXdDaGlsZCgnaW5wdXQnLCB7IHN0YXRpYzogZmFsc2UgfSkgaW5wdXQ6IEVsZW1lbnRSZWY8SFRNTElucHV0RWxlbWVudD47XG4gIEBWaWV3Q2hpbGQoTWF0QXV0b2NvbXBsZXRlLCB7IHN0YXRpYzogdHJ1ZSB9KSBtYXRBdXRvY29tcGxldGU6IE1hdEF1dG9jb21wbGV0ZTtcblxuICBzZXBhcmF0b3JLZXlzQ29kZXM6IG51bWJlcltdID0gWzEzLCA5XVxuICBvblRvdWNoOiBhbnkgPSAoKSA9PiB7IH07XG4gIG9uQ2hhbmdlOiBhbnkgPSAoKSA9PiB7IH07XG4gIGZvcm06IEZvcm1Hcm91cDtcbiAgZmlsdGVyZWRPcHRpb25zOiBhbnk7XG4gIGRpc2FibGVkID0gZmFsc2U7XG4gIGRlYm91bmNlSGVscGVyID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZiOiBGb3JtQnVpbGRlcikgeyB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5jaGFuZ2VJbnB1dCgnJyk7XG4gICAgdGhpcy5mb3JtID0gdGhpcy5mYi5ncm91cCh7XG4gICAgICBjb250cm9sOiBbJyddLFxuICAgIH0pXG4gICAgdGhpcy5mb3JtLnZhbHVlQ2hhbmdlcy5zdWJzY3JpYmUoZm9ybSA9PiB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMub25DaGFuZ2UoZm9ybS5jb250cm9sKSwgMCk7XG4gICAgfSlcbiAgICB0aGlzLmRlYm91bmNlSGVscGVyLnBpcGUoXG4gICAgICBkZWJvdW5jZSgoKSA9PiB0aW1lcih0aGlzLmRlYm91bmNlVGltZSkpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICkuc3Vic2NyaWJlKChyZXM6IHN0cmluZykgPT4gdGhpcy5jaGFuZ2VTZWFyY2hrZXkuZW1pdChyZXMpKTtcbiAgICBpZiAodGhpcy5jbGllbnRTaWRlRmlsdGVyKSB7XG4gICAgICBpZiAodGhpcy5vcHRpb25zLnNvbWUob3B0aW9uID0+IHR5cGVvZihvcHRpb24pID09PSAnc3RyaW5nJykpIHtcbiAgICAgICAgdGhpcy5pc09wdGlvblN0cmluZyA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmlzT3B0aW9uU3RyaW5nID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGdldCBjb250cm9sKCkge1xuICAgIHJldHVybiB0aGlzLmZvcm0uZ2V0KCdjb250cm9sJyk7XG4gIH1cblxuICBhZGQoZXZlbnQ6IE1hdENoaXBJbnB1dEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNDaGlwQWRkRnJvbUlucHV0ICYmICF0aGlzLm1hdEF1dG9jb21wbGV0ZS5zaG93UGFuZWwpIHtcbiAgICAgIGNvbnN0IGlucHV0ID0gZXZlbnQuaW5wdXQ7XG4gICAgICBjb25zdCB2YWx1ZSA9IGV2ZW50LnZhbHVlO1xuICAgICAgaWYgKHRoaXMuaXNPcHRpb25TdHJpbmcpIHtcbiAgICAgICAgaWYgKCh2YWx1ZSB8fCAnJykudHJpbSgpKSB7XG4gICAgICAgICAgdGhpcy5jb250cm9sLnNldFZhbHVlKFsuLi50aGlzLmNvbnRyb2wudmFsdWUgfHwgW10sIHZhbHVlLnRyaW0oKV0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBvYmogPSB7fTtcbiAgICAgICAgb2JqW3RoaXMuaXRlbUlkXSA9IHZhbHVlO1xuICAgICAgICBvYmpbdGhpcy5kaXNwbGF5V2l0aF0gPSB2YWx1ZTtcbiAgICAgICAgdGhpcy5jb250cm9sLnNldFZhbHVlKFsuLi50aGlzLmNvbnRyb2wudmFsdWUgfHwgW10sIG9ial0pO1xuICAgICAgfVxuICAgICAgLy8gUmVzZXQgdGhlIGlucHV0IHZhbHVlXG4gICAgICBpZiAoaW5wdXQpIHtcbiAgICAgICAgaW5wdXQudmFsdWUgPSAnJztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZW1vdmUoY2hpcCk6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5jb250cm9sLnZhbHVlLmZpbmRJbmRleCgoY3RyKSA9PlxuICAgICAgdGhpcy5pc09wdGlvblN0cmluZyA/IGN0ciA9PT0gY2hpcCA6IGN0clt0aGlzLml0ZW1JZF0gPT09IGNoaXBbdGhpcy5pdGVtSWRdKTtcbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgdGhpcy5jaGFuZ2VJbnB1dCgpO1xuICAgICAgdGhpcy5jb250cm9sLnZhbHVlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICBpZiAodGhpcy5jb250cm9sLnZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLmNvbnRyb2wuc2V0VmFsdWUobnVsbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xuICAgICAgfVxuICAgICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGNoYW5nZUlucHV0KGtleTogc3RyaW5nID0gJycpIHtcbiAgICB0aGlzLmNsaWVudFNpZGVGaWx0ZXIgPyB0aGlzLmZpbHRlcmVkT3B0aW9ucyA9IHRoaXMuZmlsdGVyT3B0aW9uKGtleSkgOiB0aGlzLmRlYm91bmNlSGVscGVyLm5leHQoa2V5KTtcbiAgfVxuXG4gIGZpbHRlck9wdGlvbihrZXk6IHN0cmluZykge1xuICAgIHJldHVybiAoa2V5ID09PSAnJykgPyB0aGlzLm9wdGlvbnMgOiB0aGlzLm9wdGlvbnMuZmlsdGVyKGYgPT5cbiAgICAgIHRoaXMuaXNPcHRpb25TdHJpbmcgPyBmLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoa2V5LnRvTG93ZXJDYXNlKCkpIDpcbiAgICAgICAgKGZbdGhpcy5kaXNwbGF5V2l0aF0pLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoa2V5LnRvTG93ZXJDYXNlKCkpKTtcbiAgfVxuXG4gIG9uU2VsZWN0KHZhbHVlKSB7XG4gICAgdGhpcy5jb250cm9sLnNldFZhbHVlKFsuLi50aGlzLmNvbnRyb2wudmFsdWUgfHwgW10sIHZhbHVlXSk7XG4gICAgdGhpcy5hZnRlclNlbGVjdCgpO1xuICB9XG5cbiAgYWZ0ZXJTZWxlY3QoKSB7XG4gICAgdGhpcy5pbnB1dC5uYXRpdmVFbGVtZW50LnZhbHVlID0gJyc7XG4gICAgaWYgKHRoaXMubWF4SXRlbXMgJiYgdGhpcy5jb250cm9sLnZhbHVlLmxlbmd0aCA9PT0gdGhpcy5tYXhJdGVtcykge1xuICAgICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHRoaXMuY2hhbmdlSW5wdXQoKTtcbiAgfVxuXG4gIGlzU2VsZWN0ZWQgPSAob3B0aW9uKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbC52YWx1ZSAmJiB0aGlzLmNvbnRyb2wudmFsdWUuc29tZShjdHIgPT5cbiAgICAgIHRoaXMuaXNPcHRpb25TdHJpbmcgPyBjdHIgPT09IG9wdGlvbiA6IGN0clt0aGlzLml0ZW1JZF0gPT09IG9wdGlvblt0aGlzLml0ZW1JZF0pO1xuICB9XG4gIGNob29zZUZpcnN0T3B0aW9uKGtleUNvZGUpIHtcbiAgICBpZiAodGhpcy5tYXRBdXRvY29tcGxldGUub3B0aW9ucy5maXJzdCAmJiAoIXRoaXMuY29udHJvbC52YWx1ZSB8fCAodGhpcy5jb250cm9sLnZhbHVlICYmICF0aGlzLmNvbnRyb2wudmFsdWUuc29tZShjdHIgPT5cbiAgICAgIHRoaXMuaXNPcHRpb25TdHJpbmcgPyBjdHIgPT09IHRoaXMubWF0QXV0b2NvbXBsZXRlLm9wdGlvbnMuZmlyc3QudmFsdWUgOlxuICAgICAgICBjdHJbdGhpcy5pdGVtSWRdID09PSB0aGlzLm1hdEF1dG9jb21wbGV0ZS5vcHRpb25zLmZpcnN0LnZhbHVlW3RoaXMuaXRlbUlkXSkpKSkge1xuICAgICAgaWYgKGtleUNvZGUgPT09ICdlbnRlcicpIHtcbiAgICAgICAgdGhpcy5tYXRBdXRvY29tcGxldGUub3B0aW9ucy5maXJzdC5zZWxlY3QoKTtcbiAgICAgIH0gZWxzZSBpZiAoa2V5Q29kZSA9PT0gJ3RhYicpIHtcbiAgICAgICAgdGhpcy5jb250cm9sLnNldFZhbHVlKFsuLi50aGlzLmNvbnRyb2wudmFsdWUgfHwgW10sIHRoaXMubWF0QXV0b2NvbXBsZXRlLm9wdGlvbnMuZmlyc3QudmFsdWVdKTtcbiAgICAgICAgdGhpcy5hZnRlclNlbGVjdCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBjbGlja0NoZWNrYm94V3JhcCgkZXZlbnQsIG9wdGlvbikge1xuICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLnRvZ2dsZVNlbGVjdGlvbihvcHRpb24pO1xuICB9XG4gIHRvZ2dsZVNlbGVjdGlvbihvcHRpb24pIHtcbiAgICBpZiAodGhpcy5pc1NlbGVjdGVkKG9wdGlvbikpIHtcbiAgICAgIHRoaXMucmVtb3ZlKG9wdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghdGhpcy5jb250cm9sLnZhbHVlIHx8ICF0aGlzLm1heEl0ZW1zIHx8dGhpcy5jb250cm9sLnZhbHVlLmxlbmd0aCA8IHRoaXMubWF4SXRlbXMpIHtcbiAgICAgICAgdGhpcy5vblNlbGVjdChvcHRpb24pXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb25CbHVyKCkge1xuICAgIHRoaXMuaW5wdXQubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xuICAgIHRoaXMuY2hhbmdlSW5wdXQoKTtcbiAgfVxuXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLm9uVG91Y2ggPSBmbjtcbiAgfVxuXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46IGFueSk6IHZvaWQge1xuICAgIHRoaXMub25DaGFuZ2UgPSBmbjtcbiAgfVxuXG4gIHdyaXRlVmFsdWUodmFsOiBzdHJpbmcpIHtcbiAgICB0aGlzLmNvbnRyb2wuc2V0VmFsdWUodmFsKTtcbiAgfVxuXG4gIHNldERpc2FibGVkU3RhdGUoaXNEaXNhYmxlZDogYm9vbGVhbikge1xuICAgIHRoaXMuZGlzYWJsZWQgPSBpc0Rpc2FibGVkO1xuICB9XG59Il19